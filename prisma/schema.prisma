generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  MANAGER
  STAFF
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// ==================== TENANT ====================

model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  coverImage  String?
  phone       String?
  email       String?
  address     String?
  city        String?
  district    String?
  settings    Json     @default("{}")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users         User[]
  categories    Category[]
  menuItems     MenuItem[]
  tables        Table[]
  orders        Order[]
  customers     Customer[]
  subscription  Subscription?

  @@index([slug])
  @@index([isActive])
}

// ==================== USER ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  phone         String?
  avatar        String?
  role          UserRole  @default(STAFF)
  permissions   Json      @default("[]")
  tenantId      String?
  tenant        Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([tenantId])
  @@index([role])
}

// ==================== SUBSCRIPTION ====================

model SubscriptionPlan {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  description   String?
  price         Decimal  @db.Decimal(10, 2)
  yearlyPrice   Decimal? @db.Decimal(10, 2)
  maxOrders     Int      @default(-1)
  maxTables     Int      @default(-1)
  maxAiRequests Int      @default(-1)
  maxStaff      Int      @default(-1)
  features      Json     @default("[]")
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscriptions Subscription[]
}

model Subscription {
  id                  String             @id @default(cuid())
  tenantId            String             @unique
  tenant              Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  planId              String
  plan                SubscriptionPlan   @relation(fields: [planId], references: [id])
  status              SubscriptionStatus @default(TRIAL)
  currentPeriodStart  DateTime           @default(now())
  currentPeriodEnd    DateTime
  trialEndsAt         DateTime?
  ordersUsed          Int                @default(0)
  aiRequestsUsed      Int                @default(0)
  cancelledAt         DateTime?
  cancelReason        String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  payments            Payment[]

  @@index([status])
}

model Payment {
  id              String        @id @default(cuid())
  subscriptionId  String
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("TRY")
  status          PaymentStatus @default(PENDING)
  gatewayId       String?
  gatewayResponse Json?
  invoiceNumber   String?
  invoiceUrl      String?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([subscriptionId])
  @@index([status])
}

// ==================== MENU ====================

model Category {
  id            String     @id @default(cuid())
  tenantId      String
  tenant        Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  image         String?
  icon          String?
  sortOrder     Int        @default(0)
  isActive      Boolean    @default(true)
  availableFrom String?
  availableTo   String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  menuItems     MenuItem[]

  @@index([tenantId])
  @@index([sortOrder])
}

model MenuItem {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  image       String?
  calories    Int?
  prepTime    Int?
  allergens   Json     @default("[]")
  tags        Json     @default("[]")
  variations  Json     @default("[]")
  extras      Json     @default("[]")
  sortOrder   Int      @default(0)
  isAvailable Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  OrderItem[]

  @@index([tenantId])
  @@index([categoryId])
  @@index([isAvailable])
}

// ==================== TABLE ====================

model Table {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  number    String
  area      String?
  capacity  Int      @default(4)
  qrCode    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]

  @@unique([tenantId, number])
  @@index([tenantId])
}

// ==================== ORDER ====================

model Order {
  id            String        @id @default(cuid())
  orderNumber   String
  tenantId      String
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tableId       String?
  table         Table?        @relation(fields: [tableId], references: [id], onDelete: SetNull)
  customerId    String?
  customer      Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  status        OrderStatus   @default(PENDING)
  subtotal      Decimal       @db.Decimal(10, 2)
  discount      Decimal       @default(0) @db.Decimal(10, 2)
  total         Decimal       @db.Decimal(10, 2)
  notes         String?
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String?
  aiInteraction Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  completedAt   DateTime?

  items         OrderItem[]

  @@index([tenantId])
  @@index([tableId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id                 String   @id @default(cuid())
  orderId            String
  order              Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId         String
  menuItem           MenuItem @relation(fields: [menuItemId], references: [id])
  quantity           Int      @default(1)
  unitPrice          Decimal  @db.Decimal(10, 2)
  totalPrice         Decimal  @db.Decimal(10, 2)
  selectedVariations Json     @default("[]")
  selectedExtras     Json     @default("[]")
  notes              String?
  createdAt          DateTime @default(now())

  @@index([orderId])
  @@index([menuItemId])
}

// ==================== CUSTOMER ====================

model Customer {
  id            String    @id @default(cuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  phone         String?
  email         String?
  name          String?
  loyaltyPoints Int       @default(0)
  totalSpent    Decimal   @default(0) @db.Decimal(10, 2)
  visitCount    Int       @default(0)
  preferences   Json      @default("{}")
  tags          Json      @default("[]")
  lastVisitAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  orders        Order[]

  @@unique([tenantId, phone])
  @@unique([tenantId, email])
  @@index([tenantId])
}

// ==================== PLATFORM ====================

model PlatformSettings {
  id                  String   @id @default("default")
  name                String   @default("AI Restaurant Platform")
  logo                String?
  aiProvider          String   @default("claude")
  defaultTrialDays    Int      @default(14)
  defaultCurrency     String   @default("TRY")
  defaultLanguage     String   @default("tr")
  settings            Json     @default("{}")
  updatedAt           DateTime @updatedAt
}
