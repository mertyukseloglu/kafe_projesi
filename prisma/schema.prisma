// Prisma Schema - AI Restaurant Platform
// Multi-tenant SaaS mimarisi

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SUPER_ADMIN    // Platform sahibi
  TENANT_ADMIN   // Restoran sahibi
  MANAGER        // Restoran müdürü
  STAFF          // Personel (garson, kasiyer)
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum OrderStatus {
  PENDING      // Yeni sipariş
  CONFIRMED    // Onaylandı
  PREPARING    // Hazırlanıyor
  READY        // Hazır
  DELIVERED    // Teslim edildi
  CANCELLED    // İptal edildi
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// ==================== TENANT (RESTORAN) ====================

model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique // URL için: menu.platform.com/[slug]
  description String?
  logo        String?
  coverImage  String?

  // İletişim
  phone       String?
  email       String?
  address     String?
  city        String?
  district    String?

  // Ayarlar (JSON)
  settings    Json     @default("{}")
  // { workingHours, theme, currency, language, aiSettings }

  // Durum
  isActive    Boolean  @default(true)

  // Zaman damgaları
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // İlişkiler
  users         User[]
  categories    Category[]
  menuItems     MenuItem[]
  tables        Table[]
  orders        Order[]
  customers     Customer[]
  subscription  Subscription?

  // Loyalty & Analytics
  loyaltyConfig   LoyaltyConfig?
  loyaltyRewards  LoyaltyReward[]
  dailyStats      DailyStats[]
  waiterCalls     WaiterCall[]

  // Campaigns & Coupons
  campaigns       Campaign[]
  coupons         Coupon[]

  @@index([slug])
  @@index([isActive])
}

// ==================== USER (KULLANICI) ====================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String
  phone         String?
  avatar        String?

  role          UserRole @default(STAFF)
  permissions   Json     @default("[]") // Özel yetkiler

  // Tenant ilişkisi (SUPER_ADMIN için null)
  tenantId      String?
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([tenantId])
  @@index([role])
}

// ==================== SUBSCRIPTION (ABONELİK) ====================

model SubscriptionPlan {
  id            String   @id @default(cuid())
  name          String   // Starter, Growth, Pro
  slug          String   @unique
  description   String?

  price         Decimal  @db.Decimal(10, 2) // Aylık fiyat (TL)
  yearlyPrice   Decimal? @db.Decimal(10, 2) // Yıllık fiyat

  // Limitler
  maxOrders     Int      @default(-1) // -1 = sınırsız
  maxTables     Int      @default(-1)
  maxAiRequests Int      @default(-1)
  maxStaff      Int      @default(-1)

  // Özellikler
  features      Json     @default("[]")
  // ["analytics", "loyalty", "multiLanguage", "customBranding"]

  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscriptions Subscription[]
}

model Subscription {
  id                  String             @id @default(cuid())

  tenantId            String             @unique
  tenant              Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId              String
  plan                SubscriptionPlan   @relation(fields: [planId], references: [id])

  status              SubscriptionStatus @default(TRIAL)

  // Dönem bilgileri
  currentPeriodStart  DateTime           @default(now())
  currentPeriodEnd    DateTime
  trialEndsAt         DateTime?

  // Kullanım sayaçları (aylık sıfırlanır)
  ordersUsed          Int                @default(0)
  aiRequestsUsed      Int                @default(0)

  cancelledAt         DateTime?
  cancelReason        String?

  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  payments            Payment[]

  @@index([status])
  @@index([currentPeriodEnd])
}

model Payment {
  id              String        @id @default(cuid())

  subscriptionId  String
  subscription    Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("TRY")
  status          PaymentStatus @default(PENDING)

  // Ödeme gateway bilgileri
  gatewayId       String?       // iyzico, stripe vb. referans ID
  gatewayResponse Json?

  invoiceNumber   String?
  invoiceUrl      String?

  paidAt          DateTime?
  failedAt        DateTime?
  refundedAt      DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([subscriptionId])
  @@index([status])
}

// ==================== MENU ====================

model Category {
  id          String     @id @default(cuid())

  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  description String?
  image       String?
  icon        String?    // Lucide icon adı

  // Çoklu dil desteği
  translations Json      @default("{}") // { "en": { "name": "...", "description": "..." } }

  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)

  // Zaman bazlı görünürlük (örn: kahvaltı menüsü)
  availableFrom String?  // "08:00"
  availableTo   String?  // "11:00"

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  menuItems   MenuItem[]

  @@index([tenantId])
  @@index([sortOrder])
}

model MenuItem {
  id          String   @id @default(cuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  image       String?

  // Çoklu dil desteği
  translations Json    @default("{}") // { "en": { "name": "...", "description": "..." } }

  // Stok takibi
  trackStock      Boolean @default(false)
  stockQuantity   Int     @default(0)
  lowStockAlert   Int     @default(5)  // Bu seviyenin altında uyarı
  stockUnit       String  @default("adet") // adet, porsiyon, kg, litre

  // Ek bilgiler
  calories    Int?
  prepTime    Int?     // Hazırlık süresi (dakika)

  // Alerjenler
  allergens   Json     @default("[]")
  // ["gluten", "dairy", "nuts", "shellfish", "eggs", "soy"]

  // Etiketler
  tags        Json     @default("[]")
  // ["vegan", "vegetarian", "spicy", "popular", "new"]

  // Varyasyonlar ve ekstralar
  variations  Json     @default("[]")
  // [{ name: "Boyut", options: [{ name: "Küçük", price: 0 }, { name: "Büyük", price: 10 }] }]

  extras      Json     @default("[]")
  // [{ name: "Ekstra peynir", price: 5 }, { name: "Sos", price: 3 }]

  // Maliyet ve kar marjı
  costPrice   Decimal? @db.Decimal(10, 2)

  sortOrder   Int      @default(0)
  isAvailable Boolean  @default(true)
  isFeatured  Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  OrderItem[]

  @@index([tenantId])
  @@index([categoryId])
  @@index([isAvailable])
  @@index([trackStock])
}

// ==================== TABLE (MASA) ====================

model Table {
  id          String   @id @default(cuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  number      String   // "1", "A1", "Teras-3"
  area        String?  // "İç Mekan", "Bahçe", "Teras"
  capacity    Int      @default(4)

  qrCode      String?  // QR kod URL veya data

  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders      Order[]

  @@unique([tenantId, number])
  @@index([tenantId])
}

// ==================== ORDER (SİPARİŞ) ====================

model Order {
  id          String      @id @default(cuid())
  orderNumber String      // Görüntüleme için: "S001"

  tenantId    String
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  tableId     String?
  table       Table?      @relation(fields: [tableId], references: [id], onDelete: SetNull)

  customerId  String?
  customer    Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)

  status      OrderStatus @default(PENDING)

  // Fiyatlandırma
  subtotal    Decimal     @db.Decimal(10, 2)
  discount    Decimal     @default(0) @db.Decimal(10, 2)
  total       Decimal     @db.Decimal(10, 2)

  // Notlar
  notes       String?

  // Ödeme
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String?     // "cash", "card", "online"

  // AI etkileşim logu (opsiyonel)
  aiInteraction Json?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  completedAt DateTime?

  items       OrderItem[]

  @@index([tenantId])
  @@index([tableId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id          String   @id @default(cuid())

  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  menuItemId  String
  menuItem    MenuItem @relation(fields: [menuItemId], references: [id])

  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)

  // Seçilen varyasyon ve ekstralar
  selectedVariations Json @default("[]")
  selectedExtras     Json @default("[]")

  notes       String?

  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([menuItemId])
}

// ==================== CUSTOMER (MÜŞTERİ) ====================

model Customer {
  id          String   @id @default(cuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  phone       String?
  email       String?
  name        String?

  // Sadakat programı
  loyaltyPoints Int    @default(0)
  loyaltyTier   LoyaltyTier @default(BRONZE)
  totalSpent    Decimal @default(0) @db.Decimal(10, 2)
  visitCount    Int     @default(0)

  // Tercihler
  preferences   Json    @default("{}")
  // { allergens: [], favorites: [], language: "tr" }

  // Etiketler
  tags          Json    @default("[]")
  // ["vip", "regular", "new"]

  lastVisitAt   DateTime?
  birthDate     DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  orders              Order[]
  sessions            CustomerSession[]
  loyaltyTransactions LoyaltyTransaction[]
  activityLogs        ActivityLog[]

  @@unique([tenantId, phone])
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([loyaltyTier])
}

// ==================== LOYALTY (SADAKAT) ====================

enum LoyaltyTier {
  BRONZE    // 0-499 puan
  SILVER    // 500-1499 puan
  GOLD      // 1500-4999 puan
  PLATINUM  // 5000+ puan
}

enum LoyaltyTransactionType {
  EARN          // Puan kazanma
  REDEEM        // Puan harcama
  BONUS         // Bonus puan (kampanya)
  EXPIRE        // Puan süresi dolma
  ADJUSTMENT    // Manuel düzeltme
}

model LoyaltyConfig {
  id          String   @id @default(cuid())

  tenantId    String   @unique
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Puan kazanma kuralları
  pointsPerSpent      Int     @default(1)    // Her 1 TL = 1 puan
  minSpendForPoints   Decimal @default(0) @db.Decimal(10, 2)  // Min harcama

  // Tier eşikleri
  silverThreshold     Int     @default(500)
  goldThreshold       Int     @default(1500)
  platinumThreshold   Int     @default(5000)

  // Tier çarpanları (bonus puan)
  bronzeMultiplier    Decimal @default(1) @db.Decimal(3, 2)
  silverMultiplier    Decimal @default(1.25) @db.Decimal(3, 2)
  goldMultiplier      Decimal @default(1.5) @db.Decimal(3, 2)
  platinumMultiplier  Decimal @default(2) @db.Decimal(3, 2)

  // Puan geçerliliği (gün, 0 = süresiz)
  pointsValidityDays  Int     @default(365)

  // Doğum günü bonusu
  birthdayBonusPoints Int     @default(100)

  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LoyaltyReward {
  id          String   @id @default(cuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String   // "Ücretsiz Kahve", "%10 İndirim"
  description String?

  // Ödül tipi
  rewardType  String   // "free_item", "discount_percent", "discount_amount"

  // Ödül değeri
  pointsCost  Int      // Kaç puan gerekli
  value       Decimal  @db.Decimal(10, 2)  // İndirim miktarı veya %

  // Hangi ürünler için geçerli (boş = hepsi)
  applicableItems Json @default("[]")  // menuItemId listesi

  // Minimum tier gereksinimi
  minTier     LoyaltyTier @default(BRONZE)

  // Kullanım limiti (0 = sınırsız)
  usageLimit  Int      @default(0)
  usedCount   Int      @default(0)

  isActive    Boolean  @default(true)
  validFrom   DateTime @default(now())
  validUntil  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([isActive])
}

model LoyaltyTransaction {
  id          String   @id @default(cuid())

  tenantId    String
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  type        LoyaltyTransactionType
  points      Int      // Pozitif veya negatif

  // İlişkili sipariş (varsa)
  orderId     String?

  // Açıklama
  description String?

  // İşlem öncesi ve sonrası bakiye
  balanceBefore Int
  balanceAfter  Int

  createdAt   DateTime @default(now())

  @@index([customerId])
  @@index([tenantId])
  @@index([createdAt])
}

// ==================== CUSTOMER SESSION (MÜŞTERİ OTURUMU) ====================

enum SessionStatus {
  ACTIVE      // Müşteri masada
  ORDERING    // Sipariş veriyor
  WAITING     // Sipariş bekliyor
  COMPLETED   // Ödeme yapıldı, ayrıldı
  ABANDONED   // Sipariş vermeden ayrıldı
}

model CustomerSession {
  id          String   @id @default(cuid())

  tenantId    String

  // Müşteri (opsiyonel - anonim olabilir)
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Masa
  tableId     String?
  tableNumber String?

  // Session durumu
  status      SessionStatus @default(ACTIVE)

  // Cihaz bilgileri
  deviceId    String?   // Tarayıcı fingerprint
  userAgent   String?
  ipAddress   String?

  // Zaman bilgileri
  startedAt   DateTime  @default(now())
  lastActiveAt DateTime @default(now())
  endedAt     DateTime?

  // Oturum metrikleri
  pageViews       Int   @default(0)
  menuItemViews   Int   @default(0)
  cartAdditions   Int   @default(0)
  orderCount      Int   @default(0)
  totalSpent      Decimal @default(0) @db.Decimal(10, 2)

  // İlişkili siparişler
  orderIds    Json     @default("[]")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  activityLogs ActivityLog[]

  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@index([startedAt])
}

// ==================== ACTIVITY LOG (AKTİVİTE LOGU) ====================

enum ActivityType {
  // Session
  SESSION_START       // QR tarama / menü açma
  SESSION_END         // Oturum kapanışı

  // Menu
  MENU_VIEW           // Menü görüntüleme
  CATEGORY_VIEW       // Kategori görüntüleme
  ITEM_VIEW           // Ürün detay görüntüleme
  ITEM_SEARCH         // Ürün arama

  // Cart
  CART_ADD            // Sepete ekleme
  CART_REMOVE         // Sepetten çıkarma
  CART_UPDATE         // Miktar güncelleme
  CART_CLEAR          // Sepeti temizleme

  // Order
  ORDER_CREATE        // Sipariş oluşturma
  ORDER_CANCEL        // Sipariş iptali
  ORDER_REORDER       // Tekrar sipariş

  // Payment
  PAYMENT_START       // Ödeme başlatma
  PAYMENT_SUCCESS     // Ödeme başarılı
  PAYMENT_FAILED      // Ödeme başarısız

  // Other
  WAITER_CALL         // Garson çağırma
  FEEDBACK_SUBMIT     // Geri bildirim
  LOYALTY_REDEEM      // Puan kullanma
}

model ActivityLog {
  id          String   @id @default(cuid())

  tenantId    String

  // İlişkiler (opsiyonel)
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  sessionId   String?
  session     CustomerSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  // Aktivite tipi
  type        ActivityType

  // Aktivite detayları (JSON)
  data        Json     @default("{}")
  // Örnek: { menuItemId: "xxx", quantity: 2, price: 50 }

  // Konum bilgisi
  tableNumber String?

  // Zaman damgası
  timestamp   DateTime @default(now())

  @@index([tenantId])
  @@index([customerId])
  @@index([sessionId])
  @@index([type])
  @@index([timestamp])
}

// ==================== DAILY STATS (GÜNLÜK İSTATİSTİKLER) ====================

model DailyStats {
  id          String   @id @default(cuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  date        DateTime @db.Date

  // Sipariş metrikleri
  totalOrders     Int     @default(0)
  completedOrders Int     @default(0)
  cancelledOrders Int     @default(0)

  // Gelir metrikleri
  totalRevenue    Decimal @default(0) @db.Decimal(10, 2)
  avgOrderValue   Decimal @default(0) @db.Decimal(10, 2)

  // Müşteri metrikleri
  uniqueCustomers   Int   @default(0)
  newCustomers      Int   @default(0)
  returningCustomers Int  @default(0)

  // Session metrikleri
  totalSessions     Int   @default(0)
  avgSessionDuration Int  @default(0)  // saniye
  conversionRate    Decimal @default(0) @db.Decimal(5, 2)  // %

  // Popüler ürünler (JSON)
  topItems    Json     @default("[]")
  // [{ menuItemId, name, quantity, revenue }]

  // Saat bazlı dağılım
  hourlyOrders Json    @default("[]")
  // [{ hour: 0, orders: 5, revenue: 500 }, ...]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, date])
  @@index([tenantId])
  @@index([date])
}

// ==================== WAITER CALL (GARSON ÇAĞRISI) ====================

enum WaiterCallStatus {
  PENDING
  ACKNOWLEDGED
  RESOLVED
  CANCELLED
}

model WaiterCall {
  id          String   @id @default(cuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  tableNumber String
  reason      String   // "order", "payment", "assistance", "other"
  message     String?

  status      WaiterCallStatus @default(PENDING)

  // Hangi personel aldı
  assignedTo  String?

  createdAt   DateTime @default(now())
  acknowledgedAt DateTime?
  resolvedAt  DateTime?

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
}

// ==================== CAMPAIGN & COUPON (KAMPANYA & KUPON) ====================

enum CampaignType {
  DISCOUNT_PERCENT   // Yüzde indirim
  DISCOUNT_AMOUNT    // Tutar indirim
  BUY_X_GET_Y        // X al Y öde
  FREE_ITEM          // Ücretsiz ürün
  FREE_DELIVERY      // Ücretsiz teslimat
  BUNDLE             // Paket fiyat
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  ENDED
}

model Campaign {
  id          String   @id @default(cuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  description String?
  type        CampaignType

  // İndirim değeri
  discountValue   Decimal @db.Decimal(10, 2)  // % veya TL
  minOrderAmount  Decimal? @db.Decimal(10, 2) // Min sepet tutarı
  maxDiscount     Decimal? @db.Decimal(10, 2) // Maks indirim (% için)

  // X al Y öde için
  buyQuantity     Int?
  getQuantity     Int?

  // Uygulama kapsamı
  applicableItems Json   @default("[]")  // menuItemId listesi (boş = hepsi)
  applicableCategories Json @default("[]") // categoryId listesi

  // Geçerlilik
  status      CampaignStatus @default(DRAFT)
  startDate   DateTime
  endDate     DateTime?

  // Kullanım limiti
  usageLimit  Int     @default(0)  // 0 = sınırsız
  usedCount   Int     @default(0)
  perCustomerLimit Int @default(0) // 0 = sınırsız

  // Hedef kitle
  targetTiers     Json   @default("[]")  // LoyaltyTier listesi
  targetCustomers Json   @default("[]")  // customerId listesi (boş = hepsi)
  isFirstOrderOnly Boolean @default(false)

  // Zaman kısıtlamaları
  validDays       Json   @default("[]")  // [0,1,2,3,4,5,6] = haftanın günleri
  validHoursFrom  String?  // "11:00"
  validHoursTo    String?  // "15:00"

  // Görünürlük
  isPublic    Boolean @default(true)  // Menüde göster
  bannerImage String?

  // Çoklu dil
  translations Json @default("{}") // { "en": { "name": "...", "description": "..." } }

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  coupons     Coupon[]

  @@index([tenantId])
  @@index([status])
  @@index([startDate, endDate])
}

model Coupon {
  id          String   @id @default(cuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Kampanya ile ilişki (opsiyonel - direkt kupon da olabilir)
  campaignId  String?
  campaign    Campaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  code        String   // Kupon kodu: "YENI2024", "HOSGELDIN"

  // Kampanya bağlantısı yoksa direkt indirim
  discountType    String?   // "percent", "amount"
  discountValue   Decimal?  @db.Decimal(10, 2)
  minOrderAmount  Decimal?  @db.Decimal(10, 2)
  maxDiscount     Decimal?  @db.Decimal(10, 2)

  // Geçerlilik
  isActive    Boolean  @default(true)
  startDate   DateTime @default(now())
  endDate     DateTime?

  // Kullanım limiti
  usageLimit      Int @default(0)  // 0 = sınırsız
  usedCount       Int @default(0)
  perCustomerLimit Int @default(1)

  // Kullanım kaydı
  usages      CouponUsage[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([isActive])
}

model CouponUsage {
  id          String   @id @default(cuid())

  couponId    String
  coupon      Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)

  customerId  String?
  orderId     String?

  discountApplied Decimal @db.Decimal(10, 2)

  usedAt      DateTime @default(now())

  @@index([couponId])
  @@index([customerId])
}

// ==================== STOCK LOG (STOK HAREKETLERİ) ====================

enum StockMovementType {
  IN          // Stok girişi
  OUT         // Stok çıkışı (sipariş)
  ADJUSTMENT  // Manuel düzeltme
  WASTE       // Fire/kayıp
  TRANSFER    // Transfer
}

model StockMovement {
  id          String   @id @default(cuid())

  tenantId    String

  menuItemId  String

  type        StockMovementType
  quantity    Int       // + veya -

  // Önceki ve sonraki stok
  previousStock Int
  newStock      Int

  // Açıklama
  reason      String?
  orderId     String?   // Sipariş kaynaklı ise
  userId      String?   // İşlemi yapan kullanıcı

  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([menuItemId])
  @@index([createdAt])
}

// ==================== TRANSLATIONS (ÇEVİRİLER) ====================

model Translation {
  id          String   @id @default(cuid())

  tenantId    String?  // null = platform geneli

  // Hangi model ve alan
  entityType  String   // "menu_item", "category", "campaign"
  entityId    String   // İlgili kaydın ID'si
  field       String   // "name", "description"

  // Çeviriler
  locale      String   // "en", "tr", "de", "ar"
  value       String   @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([entityType, entityId, field, locale])
  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([locale])
}

// ==================== PLATFORM SETTINGS ====================

model PlatformSettings {
  id          String   @id @default("default")

  name        String   @default("AI Restaurant Platform")
  logo        String?

  // API Keys (encrypted olmalı production'da)
  aiProvider  String   @default("claude") // "openai" veya "claude"

  // Varsayılan ayarlar
  defaultTrialDays    Int @default(14)
  defaultCurrency     String @default("TRY")
  defaultLanguage     String @default("tr")

  // Email şablonları vb.
  settings    Json     @default("{}")

  updatedAt   DateTime @updatedAt
}
